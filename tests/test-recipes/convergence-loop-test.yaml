name: "convergence-loop-test"
description: "Test while_condition, break_when, and update_context features"
version: "1.0.0"

context:
  iteration: 0
  max_iterations: 5
  target_value: 3
  current_value: 0
  converged: false

steps:
  # Test basic while loop with state mutation
  - id: "increment-until-target"
    while_condition: "{{iteration}} < {{max_iterations}} and not {{converged}}"
    max_while_iterations: 10
    type: "bash"
    command: |
      echo "Iteration {{iteration}}: current_value={{current_value}}, target={{target_value}}"
      echo '{"new_value": '$(({{current_value}} + 1))', "reached_target": '$([[ $(({{current_value}} + 1)) -ge {{target_value}} ]] && echo "true" || echo "false")'}'
    output: "result"
    parse_json: true
    update_context:
      iteration: "{{iteration}} + 1"
      current_value: "{{result.new_value}}"
      converged: "{{result.reached_target}}"
    break_when: "{{result.reached_target}} == 'true'"
  
  # Verify final state
  - id: "verify-result"
    type: "bash"
    command: |
      echo "Final state: iteration={{iteration}}, value={{current_value}}, converged={{converged}}"
      if [[ {{converged}} == "true" ]]; then
        echo "SUCCESS: Converged at iteration {{iteration}}"
      else
        echo "FAILURE: Did not converge"
        exit 1
      fi
    output: "verification"
